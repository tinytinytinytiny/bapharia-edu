---
import BaseLayout from "@layouts/BaseLayout.astro";
import PageTitle from "@components/PageTitle/PageTitle.astro";
---

<BaseLayout>
	<PageTitle title="Offline">
		<p><b>Congratulations!</b> You are touching grass</p>
	</PageTitle>
	<div class="content">
		<div class="article content-wrapper stack" id="insert-html-here">
			<p class="h2">It appears you are offline.</p>
			<noscript>
				<p>And there is nothing you can do. Cry about it.</p>
			</noscript>
		</div>
	</div>
</BaseLayout>

<script is:inline>
	const getVersion = (name) => Number(name.split("_")[0].split(".").join(""));
	window.caches.keys().then((cacheNames) => {
		const pagesCacheName = cacheNames
			.filter((name) => name.includes("pages"))
			.sort((a, b) => {
				if (getVersion(a) < getVersion(b)) {
					return 1;
				} else if (getVersion(a) > getVersion(b)) {
					return -1;
				}
				return 0;
			})[0];

		window.caches.open(pagesCacheName).then((cache) => {
			cache.keys().then((cachedPages) => {
				if (cachedPages.length) {
					const p = document.createElement("p");
					p.appendChild(
						document.createTextNode(
							"But do not pororiâ€”here are some pages you can view right now:",
						),
					);
					const ul = document.createElement("ul");
					new Set(
						cachedPages.map(
							(page) => page.url.replace(/\/$/, "") + "/",
						),
					).forEach((url) => {
						const li = document.createElement("li");
						const a = document.createElement("a");
						const pathname = new URL(url).pathname;
						a.href = pathname;
						a.appendChild(document.createTextNode(pathname));
						li.appendChild(a);
						ul.appendChild(li);
					});
					const fragment = document.createDocumentFragment();
					fragment.appendChild(p);
					fragment.appendChild(ul);
					document
						.getElementById("insert-html-here")
						.appendChild(fragment);
				} else {
					const p = document.createElement("p");
					p.appendChild(
						document.createTextNode(
							"And there is nothing you can do. Cry about it.",
						),
					);
					document.getElementById("insert-html-here").appendChild(p);
				}
			});
		});
	});
</script>
