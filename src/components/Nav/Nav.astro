---
import navigationData from "@data/navigation";
import NavItem from "./NavItem.astro";
import NavItemDisclosure from "./NavItemDisclosure.astro";
import ThemeToggle from "./ThemeToggle.astro";
import Svg from "@jasikpark/astro-svg-loader";
import { slugify } from "@utils";

function isCurrentUrl(url) {
	const rootPathName = "/" + Astro.url.pathname.split("/")[1];
	return url === rootPathName;
}
---

<nav class="primary-nav" aria-label="Main">
	<div class="primary-nav__inner">
		<button
			aria-controls="main-menu"
			aria-expanded="false"
			class="nav-toggle button icon-button shadow-md"
			type="button"
		>
			<div class="icon">
				<Svg
					src={import("@assets/icons/three-line-horizontal.svg?raw")}
				/>
			</div>
			Menu
		</button>
		<div id="main-menu" class="nav-menu">
			<ul class="is-full" role="list">
				{
					navigationData.map((item) =>
						"children" in item ? (
							<NavItemDisclosure
								title={item.title}
								url={item.url}
								icon={item.icon}
								id={`nav-${slugify(item.title)}-submenu`}
								current={isCurrentUrl(item.url)}
							>
								<ul role="list">
									{item.children.map((child) => (
										<li class="nav-submenu-item">
											<a
												href={child.url}
												class="nav-submenu-item__link underline-on-hover"
												aria-current={
													child.current ? "page" : "false"
												}
											>
												{child.title}
											</a>
										</li>
									))}
								</ul>
							</NavItemDisclosure>
						) : (
							<NavItem
								title={item.title}
								url={item.url}
								icon={item.icon}
								current={isCurrentUrl(item.url)}
							/>
						)
					)
				}
			</ul>
			<ThemeToggle />
		</div>
	</div>
</nav>

<style>
	.primary-nav {
		inset-inline: 0;
		position: fixed;
		top: 0;
		z-index: 10;
	}

	.primary-nav.open {
		background-color: var(--color-surface-2);
		height: 100vh;
		height: 100lvh;
		inset-inline: 0;
	}

	.primary-nav__inner {
		padding-block: var(--space-s);
	}

	.open > .primary-nav__inner {
		height: 100%;
		height: 100dvh;
		overflow-y: auto;
		overscroll-behavior: contain;
	}

	.nav-toggle {
		margin-inline: var(--space-s);
	}

	.primary-nav.open .nav-toggle {
		inset-block-start: 0;
		position: sticky;
	}

	.nav-menu {
		display: none;
		flex-flow: column nowrap;
		font-size: var(--text-1);
		margin-block-start: var(--space-m);
		padding-inline: var(--space-2xs);
		padding-bottom: env(safe-area-inset-bottom);
	}

	[aria-expanded="true"] + .nav-menu {
		display: flex;
	}

	@screen md {
		.primary-nav,
		.primary-nav.open {
			height: 100vh;
			height: 100lvh;
			inset-block-start: 0;
			inset-inline-end: auto;
		}

		.primary-nav.open {
			background-color: transparent;
		}

		.primary-nav__inner,
		.open > .primary-nav__inner {
			block-size: 100%;
			block-size: 100dvh;
			padding: 0;
		}

		.open > .primary-nav__inner {
			overflow: initial;
		}

		.nav-toggle {
			display: none;
		}

		.nav-menu {
			align-items: center;
			block-size: 100%;
			display: flex;
			font-size: var(--text-0);
			inline-size: var(--sidebar-width);
			margin-block-start: 0;
			overflow-y: auto;
			padding-block: var(--space-2xs) var(--space-s);
		}
	}
</style>

<script>
	const nav = document.querySelector(".primary-nav");
	const navToggle = document.querySelector(".nav-toggle");
	let expanded = JSON.parse(navToggle.getAttribute("aria-expanded"));

	navToggle.addEventListener("click", () => {
		expanded = !expanded;
		if (expanded) {
			document.documentElement.classList.add("fixed-overlay-visible");
			nav.classList.add("open");
		} else {
			document.documentElement.classList.remove("fixed-overlay-visible");
			nav.classList.remove("open");
		}
		navToggle.setAttribute("aria-expanded", expanded);
	});
</script>
